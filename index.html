<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Client</title>

<style>
body{
    font-family:Arial, sans-serif;
    background:#111;
    color:#fff;
    margin:0;
    padding:20px;
}

.container{
    max-width:800px;
    margin:auto;
}

input, textarea, select, button{
    width:100%;
    padding:10px;
    margin-top:8px;
    border-radius:8px;
    border:none;
    font-size:14px;
}

button{
    background:#2ecc71;
    color:white;
    cursor:pointer;
}

button:hover{
    opacity:0.9;
}

.ticket-card{
    background:#1e1e1e;
    padding:15px;
    margin-top:15px;
    border-radius:12px;
    transition:0.2s;
}

.ticket-card:hover{
    transform:translateY(-3px);
    box-shadow:0 8px 20px rgba(0,0,0,0.4);
}

.badge{
    padding:4px 10px;
    border-radius:20px;
    font-size:12px;
    color:white;
}

.header{
    display:flex;
    justify-content:space-between;
    align-items:center;
}
</style>
</head>

<body>
<div class="container">

<h2>Support Ticket</h2>

<div id="loginBox">
    <input id="username" placeholder="Inserisci nome utente">
    <button onclick="login()">Login</button>
</div>

<div id="app" style="display:none;">
    <div class="header">
        <div>Utente: <strong id="currentUser"></strong></div>
        <button onclick="logout()" style="background:#e74c3c;width:auto;padding:6px 12px;">Logout</button>
    </div>

    <h3>Apri Nuovo Ticket</h3>
    <input id="title" placeholder="Titolo">
    <textarea id="description" placeholder="Descrizione"></textarea>
    <select id="priority">
        <option value="bassa">Bassa</option>
        <option value="media">Media</option>
        <option value="alta">Alta</option>
    </select>
    <button onclick="createTicket()">Invia Ticket</button>

    <h3>I Miei Ticket</h3>
    <div id="ticketList"></div>
</div>

</div>

<script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
<script>

/* CONFIG */
const DROPBOX_APP_KEY = "djxi8x2gj3ss38l";
const DROPBOX_FOLDER = "/tickets";

/* GLOBAL */
let dbx;
let currentUser;

/* LOGIN */
function login(){
    const username = document.getElementById("username").value.trim();
    if(!username) return alert("Inserisci username");

    currentUser = {
        username,
        userId: crypto.randomUUID()
    };

    localStorage.setItem("ticketUser", JSON.stringify(currentUser));
    initApp();
}

function logout(){
    localStorage.removeItem("ticketUser");
    location.reload();
}

function getSavedUser(){
    return JSON.parse(localStorage.getItem("ticketUser"));
}

/* INIT */
async function initApp(){
    currentUser = getSavedUser();
    if(!currentUser) return;

    document.getElementById("loginBox").style.display="none";
    document.getElementById("app").style.display="block";
    document.getElementById("currentUser").innerText=currentUser.username;

    dbx = new Dropbox.Dropbox({ accessToken: localStorage.getItem("dropbox_token") });

    await ensureUserFolder();
    loadTickets();
}

/* ENSURE USER FOLDER */
async function ensureUserFolder(){
    const path = `${DROPBOX_FOLDER}/${currentUser.userId}`;

    try{
        await dbx.filesGetMetadata({path});
    }catch(e){
        await dbx.filesCreateFolderV2({path});
    }
}

/* CREATE TICKET */
async function createTicket(){
    const title = document.getElementById("title").value;
    const description = document.getElementById("description").value;
    const priority = document.getElementById("priority").value;

    if(!title || !description) return alert("Compila tutti i campi");

    const ticket = {
        id: Date.now(),
        title,
        description,
        priority,
        status:"open",
        createdAt:new Date().toISOString(),
        userId: currentUser.userId,
        username: currentUser.username
    };

    const path = `${DROPBOX_FOLDER}/${currentUser.userId}/ticket_${ticket.id}.json`;

    await dbx.filesUpload({
        path,
        contents: JSON.stringify(ticket),
        mode:"add"
    });

    document.getElementById("title").value="";
    document.getElementById("description").value="";

    loadTickets();
}

/* LOAD TICKETS */
async function loadTickets(){
    const list = document.getElementById("ticketList");
    list.innerHTML="Caricamento...";

    const path = `${DROPBOX_FOLDER}/${currentUser.userId}`;

    const res = await dbx.filesListFolder({path});
    const entries = res.result.entries;

    list.innerHTML="";

    for(const file of entries){
        const fileData = await dbx.filesDownload({path:file.path_lower});
        const text = await fileData.result.fileBlob.text();
        const ticket = JSON.parse(text);
        renderTicket(ticket);
    }

    if(entries.length===0){
        list.innerHTML="Nessun ticket";
    }
}

/* RENDER */
function renderTicket(ticket){
    const STATUS = {
        open:{label:"Aperto",color:"#e74c3c"},
        working:{label:"In lavorazione",color:"#f39c12"},
        closed:{label:"Chiuso",color:"#2ecc71"}
    };

    const status = STATUS[ticket.status];

    const card = document.createElement("div");
    card.className="ticket-card";
    card.innerHTML=`
        <strong>${ticket.title}</strong>
        <span class="badge" style="background:${status.color};float:right">
            ${status.label}
        </span>
        <p>${ticket.description}</p>
        <small>${new Date(ticket.createdAt).toLocaleString()}</small>
    `;

    document.getElementById("ticketList").appendChild(card);
}

/* AUTO INIT */
window.onload=()=>{
    if(getSavedUser()){
        initApp();
    }
};

</script>
</body>
</html>


