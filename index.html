<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IT Ticket - Client</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
    margin:0;
    font-family:Inter,sans-serif;
    background:#f1f5f9;
    color:#0f172a;
}
header{
    background:#0f172a;
    color:white;
    padding:16px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
header input{
    width:180px;
    padding:6px;
    border-radius:6px;
    border:none;
}
.container{
    max-width:800px;
    margin:auto;
    padding:20px;
}
.card{
    background:white;
    border-radius:16px;
    padding:20px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
    margin-bottom:20px;
}
input, textarea{
    width:100%;
    padding:10px;
    margin-bottom:12px;
    border-radius:8px;
    border:1px solid #cbd5e1;
}
button{
    padding:10px 15px;
    border:none;
    border-radius:8px;
    background:#0f172a;
    color:white;
    cursor:pointer;
}
.badge{
    padding:6px 10px;
    border-radius:20px;
    font-size:12px;
    font-weight:600;
}
.badge.aperto{ background:#fee2e2;color:#991b1b; }
.badge.in_lavorazione{ background:#fef9c3;color:#92400e; }
.badge.chiuso{ background:#dcfce7;color:#166534; }
</style>
</head>

<body>

<header>
<div>IT Support - Client</div>
<div>
Utente:
<input id="username" placeholder="Inserisci nome">
</div>
</header>

<div class="container">

<div class="card">
<h3>Apri Nuovo Ticket</h3>
<input id="problema" placeholder="Titolo problema">
<textarea id="descrizione" placeholder="Descrizione"></textarea>
<button onclick="creaTicket()">Invia Ticket</button>
</div>

<div class="card">
<h3>I Miei Ticket</h3>
<div id="ticketList">Nessun ticket</div>
</div>

</div>

<script>

/* ================= CONFIG ================= */

const DROPBOX_APP_KEY="djxi8x2gj3ss38l";
const DROPBOX_FOLDER="/tickets";
const REDIRECT_URI="https://evotechlab.github.io/ticketclient/";

let accessToken=localStorage.getItem("db_access");
let refreshToken=localStorage.getItem("db_refresh");

const usernameInput=document.getElementById("username");
usernameInput.value=localStorage.getItem("ticket_username")||"";

usernameInput.addEventListener("input",()=>{
    localStorage.setItem("ticket_username",usernameInput.value.trim());
});

/* ================= AUTH ================= */

function generateRandomString(length){
    const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let result="";
    for(let i=0;i<length;i++) result+=chars.charAt(Math.floor(Math.random()*chars.length));
    return result;
}

async function sha256base64url(str){
    const encoder=new TextEncoder();
    const data=encoder.encode(str);
    const hash=await crypto.subtle.digest("SHA-256",data);
    return btoa(String.fromCharCode(...new Uint8Array(hash)))
        .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}

async function initDropboxAuth(){

    const params=new URLSearchParams(window.location.search);
    const code=params.get("code");

    if(code && !accessToken){

        const codeVerifier=localStorage.getItem("pkce_code_verifier");

        const response=await fetch("https://api.dropboxapi.com/oauth2/token",{
            method:"POST",
            headers:{"Content-Type":"application/x-www-form-urlencoded"},
            body:new URLSearchParams({
                code,
                grant_type:"authorization_code",
                client_id:DROPBOX_APP_KEY,
                redirect_uri:REDIRECT_URI,
                code_verifier:codeVerifier
            })
        });

        const data=await response.json();

        accessToken=data.access_token;
        refreshToken=data.refresh_token;

        localStorage.setItem("db_access",accessToken);
        localStorage.setItem("db_refresh",refreshToken);

        window.history.replaceState({},document.title,REDIRECT_URI);
    }

    if(!accessToken && !refreshToken){

        const codeVerifier=generateRandomString(64);
        const codeChallenge=await sha256base64url(codeVerifier);
        localStorage.setItem("pkce_code_verifier",codeVerifier);

        const authUrl=
        `https://www.dropbox.com/oauth2/authorize?client_id=${DROPBOX_APP_KEY}&response_type=code&token_access_type=offline&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&code_challenge=${codeChallenge}&code_challenge_method=S256`;

        window.location.href=authUrl;
    }
}

async function refreshAccessToken(){
    const response=await fetch("https://api.dropboxapi.com/oauth2/token",{
        method:"POST",
        headers:{"Content-Type":"application/x-www-form-urlencoded"},
        body:new URLSearchParams({
            grant_type:"refresh_token",
            refresh_token:refreshToken,
            client_id:DROPBOX_APP_KEY
        })
    });
    const data=await response.json();
    accessToken=data.access_token;
    localStorage.setItem("db_access",accessToken);
}

async function dropboxFetch(url,options={}){
    options.headers=options.headers||{};
    options.headers["Authorization"]="Bearer "+accessToken;

    let response=await fetch(url,options);

    if(response.status===401 && refreshToken){
        await refreshAccessToken();
        options.headers["Authorization"]="Bearer "+accessToken;
        response=await fetch(url,options);
    }

    return response;
}

/* ================= USER FILE ================= */

function getUserFilePath(user){
    return `${DROPBOX_FOLDER}/user_${user.toLowerCase().replace(/\s+/g,"_")}.json`;
}

async function getUserHistory(user){

    const res=await dropboxFetch(
        "https://content.dropboxapi.com/2/files/download",
        {
            method:"POST",
            headers:{
                "Dropbox-API-Arg":JSON.stringify({path:getUserFilePath(user)})
            }
        }
    );

    if(res.status!==200){
        return {user,tickets:[]};
    }

    return await res.json();
}

async function saveUserHistory(user,data){

    await dropboxFetch(
        "https://content.dropboxapi.com/2/files/upload",
        {
            method:"POST",
            headers:{
                "Content-Type":"application/octet-stream",
                "Dropbox-API-Arg":JSON.stringify({
                    path:getUserFilePath(user),
                    mode:"overwrite"
                })
            },
            body:JSON.stringify(data)
        }
    );
}

/* ================= CREA TICKET ================= */

async function creaTicket(){

    const user=usernameInput.value.trim();
    if(!user){
        alert("Inserisci nome utente");
        return;
    }

    const id=Date.now().toString();

    const ticket={
        id,
        timestamp:new Date().toISOString(),
        user:user,
        problema:document.getElementById("problema").value,
        descrizione:document.getElementById("descrizione").value,
        stato:"aperto"
    };

    // salva ticket singolo per admin
    await dropboxFetch(
        "https://content.dropboxapi.com/2/files/upload",
        {
            method:"POST",
            headers:{
                "Content-Type":"application/octet-stream",
                "Dropbox-API-Arg":JSON.stringify({
                    path:`${DROPBOX_FOLDER}/ticket_${id}.json`,
                    mode:"add"
                })
            },
            body:JSON.stringify(ticket)
        }
    );

    // aggiorna storico utente
    const history=await getUserHistory(user);
    history.tickets.push(ticket);

    await saveUserHistory(user,history);

    document.getElementById("problema").value="";
    document.getElementById("descrizione").value="";

    loadTickets();
}

/* ================= LOAD ================= */

async function loadTickets(){

    const user=usernameInput.value.trim();
    if(!user) return;

    const history=await getUserHistory(user);

    history.tickets.sort((a,b)=>b.id-a.id);

    let html="";

    for(const ticket of history.tickets){

        html+=`
        <div style="margin-bottom:12px;">
            <strong>${ticket.problema}</strong><br>
            <span class="badge ${ticket.stato}">
                ${ticket.stato.replace("_"," ").toUpperCase()}
            </span>
        </div>`;
    }

    document.getElementById("ticketList").innerHTML=
        html || "Nessun ticket trovato";
}

/* ================= INIT ================= */

async function init(){
    await initDropboxAuth();
    setInterval(loadTickets,4000);
    loadTickets();
}

init();

</script>

</body>
</html>




